@page "/"
@using InventoryManagementSystem.Services
@using InventoryManagementSystem.Models
@using Radzen
@using Radzen.Blazor

@inject IProductService ProductService
@inject IStockTransactionService TransactionService
@inject IWorkOrderService WorkOrderService
@inject IProductionLogService ProductionLogService
@inject NotificationService NotificationService

<RadzenText TextStyle="TextStyle.H4" Text="Dashboard" Class="mb-4" />

@if (isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    @* Top KPI Cards *@
    <RadzenRow Class="mb-4">
        <RadzenColumn Size="3">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Active Orders</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-info">@activeCount</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">In Progress</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-primary">@inProgressCount</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Completed Today</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-success">@completedTodayCount</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Pending Orders</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-warning">@pendingCount</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @* Inventory KPI Cards *@
    <RadzenRow Class="mb-4">
        <RadzenColumn Size="4">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Total Products</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-secondary">@totalProducts</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="4">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Low Stock Items</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-danger">@lowStockProducts.Count</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="4">
            <RadzenCard>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Stock Value</RadzenText>
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-success">@totalValue.ToString("C")
                    </RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @* Tabbed View for Details *@
    <RadzenTabs RenderMode="TabRenderMode.Client" Class="mb-4">
        <Tabs>
            <RadzenTabsItem Text="Production">
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Work Orders</RadzenText>
                            @if (loadingOrders)
                            {
                                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            }
                            else if (filteredWorkOrders.Any())
                            {
                                <RadzenDataGrid Data="@filteredWorkOrders" TItem="WorkOrder" AllowPaging="true" PageSize="5">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="WorkOrder" Property="OrderNumber" Title="Order #"
                                            Width="100px" />
                                        <RadzenDataGridColumn TItem="WorkOrder" Property="Product.Name" Title="Product" />
                                        <RadzenDataGridColumn TItem="WorkOrder" Title="Progress" Width="100px">
                                            <Template Context="w">
                                                @($"{w.QuantityProduced} / {w.QuantityOrdered}")
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="WorkOrder" Property="Status" Title="Status" Width="120px">
                                            <Template Context="w">
                                                <RadzenBadge BadgeStyle="@GetStatusBadge(w.Status)"
                                                    Text="@w.Status.ToString()" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Caption">No work orders.</RadzenText>
                            }
                        </RadzenCard>
                    </RadzenColumn>

                    <RadzenColumn Size="6">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Production Logs</RadzenText>
                            @if (filteredLogs.Any())
                            {
                                <RadzenDataGrid Data="@filteredLogs" TItem="ProductionLog" AllowPaging="true" PageSize="5">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="ProductionLog" Property="ProductionDate" Title="Date"
                                            FormatString="{0:MM/dd HH:mm}" Width="140px" />
                                        <RadzenDataGridColumn TItem="ProductionLog" Property="WorkOrder.Product.Name"
                                            Title="Product" />
                                        <RadzenDataGridColumn TItem="ProductionLog" Property="QuantityProduced" Title="Qty"
                                            Width="80px" />
                                    </Columns>
                                </RadzenDataGrid>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Caption">No logs yet.</RadzenText>
                            }
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Inventory Overview">
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Low Stock Alerts</RadzenText>
                            @if (filteredLowStock.Any())
                            {
                                <RadzenDataGrid Data="@filteredLowStock" TItem="Product" AllowPaging="true" PageSize="5">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="Product" Property="Name" Title="Product" />
                                        <RadzenDataGridColumn TItem="Product" Property="Quantity" Title="Stock" Width="80px"
                                            TextAlign="TextAlign.Center">
                                            <Template Context="p">
                                                <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="@($"{p.Quantity}")" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="Product" Property="MinimumStock" Title="Min" Width="80px"
                                            TextAlign="TextAlign.Center" />
                                    </Columns>
                                </RadzenDataGrid>
                            }
                            else
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">No low
                                    stock items.</RadzenAlert>
                            }
                        </RadzenCard>
                    </RadzenColumn>

                    <RadzenColumn Size="6">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Recent Transactions</RadzenText>
                            @if (filteredTransactions.Any())
                            {
                                <RadzenDataGrid Data="@filteredTransactions" TItem="StockTransaction" AllowPaging="true"
                                    PageSize="5">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="StockTransaction" Property="Product.Name"
                                            Title="Product" />
                                        <RadzenDataGridColumn TItem="StockTransaction" Property="Type" Title="Type"
                                            Width="100px">
                                            <Template Context="t">
                                                <RadzenBadge BadgeStyle="@GetBadge(t.Type)" Text="@t.Type.ToString()" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="StockTransaction" Property="Quantity" Title="Qty"
                                            Width="80px" />
                                        <RadzenDataGridColumn TItem="StockTransaction" Property="TransactionDate" Title="Date"
                                            FormatString="{0:MM/dd}" Width="80px" />
                                    </Columns>
                                </RadzenDataGrid>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Body2">No transactions.</RadzenText>
                            }
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    @* Charts Section *@
    <RadzenRow Class="mb-4">
        <RadzenColumn Size="6">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" Class="mb-4">Order Status Distribution</RadzenText>
                <RadzenChart>
                    <RadzenPieSeries Data="@statusDistribution" Title="Orders" CategoryProperty="Status"
                        ValueProperty="Count">
                        <RadzenSeriesDataLabels Visible="true" />
                    </RadzenPieSeries>
                </RadzenChart>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="6">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" Class="mb-4">Production Output (Last 7 Days)</RadzenText>
                <RadzenChart>
                    <RadzenColumnSeries Data="@productionTrend" CategoryProperty="Date" ValueProperty="Quantity"
                        Title="Units Produced" LineType="LineType.Dashed" />
                    <RadzenColumnOptions Radius="5" />
                    <RadzenValueAxis Min="0" />
                </RadzenChart>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@implements IDisposable

@code {
    bool isLoading = true;
    bool loadingOrders = false;

    // Full Data (Source of truth)
    List<WorkOrder> allWorkOrders = new();
    List<ProductionLog> allLogs = new();
    List<Product> lowStockProducts = new();
    List<StockTransaction> allTransactions = new();

    // Filtered Data (Bind to UI - simply sorted now)
    List<WorkOrder> filteredWorkOrders = new();
    List<ProductionLog> filteredLogs = new();
    List<Product> filteredLowStock = new();
    List<StockTransaction> filteredTransactions = new();

    // KPIs & Charts
    int activeCount;
    int inProgressCount;
    int completedTodayCount;
    int pendingCount;

    // Inventory KPIs
    int totalProducts;
    decimal totalValue;

    class StatusMetric { public string Status { get; set; } = ""; public int Count { get; set; } }
    class ProductionMetric { public string Date { get; set; } = ""; public int Quantity { get; set; } }

    List<StatusMetric> statusDistribution = new();
    List<ProductionMetric> productionTrend = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            WorkOrderService.OnChange += HandleStateChange;
            WorkOrderService.OnSystemNotification += HandleNotification;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    void ApplyFilters()
    {
        // No actual filtering anymore, just sorting
        filteredWorkOrders = allWorkOrders.OrderByDescending(w => w.StartDate).ToList();
        filteredLogs = allLogs.OrderByDescending(l => l.ProductionDate).ToList();
        filteredTransactions = allTransactions.OrderByDescending(t => t.TransactionDate).ToList();
        filteredLowStock = lowStockProducts.OrderBy(p => p.Quantity).ToList();
    }

    BadgeStyle GetBadge(TransactionType type)
    {
        return type switch
        {
            TransactionType.StockIn => BadgeStyle.Success,
            TransactionType.StockOut => BadgeStyle.Danger,
            TransactionType.Adjustment => BadgeStyle.Warning,
            _ => BadgeStyle.Light
        };
    }

    BadgeStyle GetStatusBadge(WorkOrderStatus status)
    {
        return status switch
        {
            WorkOrderStatus.Pending => BadgeStyle.Warning,
            WorkOrderStatus.InProgress => BadgeStyle.Primary,
            WorkOrderStatus.Completed => BadgeStyle.Success,
            WorkOrderStatus.Cancelled => BadgeStyle.Light,
            _ => BadgeStyle.Light
        };
    }

    public void Dispose()
    {
        WorkOrderService.OnChange -= HandleStateChange;
        WorkOrderService.OnSystemNotification -= HandleNotification;
    }

    private void HandleNotification(string message, NotificationSeverity severity)
    {
        InvokeAsync(() => NotificationService.Notify(severity, "System Update", message, duration: 4000));
    }

    private async void HandleStateChange()
    {
        await InvokeAsync(async () =>
        {
            await LoadDataAsync();
            StateHasChanged();
        });
    }

    private async Task LoadDataAsync()
    {
        try
        {
            // Load Inventory
            var allProducts = await ProductService.GetAllProductsAsync();
            totalProducts = allProducts.Count;
            totalValue = allProducts.Sum(p => p.Price * p.Quantity);

            lowStockProducts = await ProductService.GetLowStockProductsAsync();
            allTransactions = await TransactionService.GetRecentTransactionsAsync(50);
            allWorkOrders = await WorkOrderService.GetAllWorkOrdersAsync();
            allLogs = await ProductionLogService.GetRecentLogsAsync(50);

            // Calculate KPIs
            activeCount = allWorkOrders.Count(w => w.Status == WorkOrderStatus.Pending || w.Status == WorkOrderStatus.InProgress);
            pendingCount = allWorkOrders.Count(w => w.Status == WorkOrderStatus.Pending);
            inProgressCount = allWorkOrders.Count(w => w.Status == WorkOrderStatus.InProgress);
            completedTodayCount = allWorkOrders.Count(w => w.Status == WorkOrderStatus.Completed && w.CompletionDate?.Date ==
            DateTime.Today);

            // Calculate Chart Data
            statusDistribution = allWorkOrders
            .GroupBy(w => w.Status)
            .Select(g => new StatusMetric { Status = g.Key.ToString(), Count = g.Count() })
            .ToList();

            productionTrend = allLogs
            .Where(l => l.ProductionDate >= DateTime.Today.AddDays(-6))
            .GroupBy(l => l.ProductionDate.Date)
            .Select(g => new ProductionMetric { Date = g.Key.ToString("MM/dd"), Quantity = g.Sum(l => l.QuantityProduced) })
            .OrderBy(m => m.Date)
            .ToList();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to refresh data: {ex.Message}");
        }
    }
}